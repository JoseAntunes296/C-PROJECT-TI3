@{
    ViewBag.Title = "Administração";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    label {
        float: left;
    }

    .col-md-3.col-sm-6 {
        margin-bottom: 2rem !important;
    }

    .dropdown {
        position: relative;
    }

    .dropdown-menu {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
    }

    .scrollable-menu {
        height: auto;
        max-height: 200px;
        overflow-x: hidden;
    }

    .result-item {
        padding: 8px;
        cursor: pointer;
    }

        .result-item:hover {
            background-color: #f1f1f1;
        }

    .list-group-item.disabled, .list-group-item:disabled {
        background-color: #222831;
        color: white;
    }

    .list-group-item {
        opacity: 0.8;
        background-color: #222831;
        color: white;
        transition: 0.3s;
        position: relative;
    }

        .list-group-item:hover {
            opacity: 1.2;
            color: white;
            border-color: #225841;
        }

            .list-group-item:hover::before {
                content: '';
                position: absolute;
                top: -1px;
                left: 0;
                width: 100%;
                height: 1px;
                background-color: #225841;
            }
</style>
<div class="row text-center">
    @{
        if (Session["IdUser"] != null && Session["administrator"] != null)
        {
            if ((int)Session["administrator"] != 1)
            {
                Response.Redirect("/Home/Index");
            }
        }
        else
        {
            Response.Redirect("/Home/Index");
        }
    }
    <div class="col-md-3 col-sm-6 ">
        <a href="/Home/Index" class="btn hoverView" style="width: 13rem; height: 8rem;">
            <div class="card-body">
                <ion-icon size="large" name="arrow-undo-outline"></ion-icon>
                <h5 class="card-title">Voltar atrás</h5>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 ">
        <a href="#" class="btn hoverView" style="width: 13rem; height: 8rem;" data-toggle="modal" data-target="#addProjectModal">
            <div class="card-body">
                <ion-icon size="large" name="receipt-outline"></ion-icon>
                <h5 class="card-title">Adicionar Projectos</h5>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="#" class="btn hoverView" style="width: 13rem; height: 8rem;" data-toggle="modal" data-target="#addTaskModal">
            <div class="card-body">
                <ion-icon size="large" name="document-outline"></ion-icon>
                <h5 class="card-title">Adicionar Tarefas</h5>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 ">
        <a href="#" class="btn hoverView" style="width: 13rem; height: 8rem;" data-toggle="modal" data-target="#addUserModal">
            <div class="card-body">
                <ion-icon size="large" name="person-add-outline"></ion-icon>
                <h5 class="card-title">Adicionar Utilizadores</h5>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 ">
        <a href="/AdminPanel/ManageProjects" class="btn hoverView" style="width: 13rem; height: 8rem;">
            <div class="card-body">
                <ion-icon size="large" name="create-outline"></ion-icon>
                <h5 class="card-title">Editar Projetos e Tarefas</h5>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 ">
        <a href="/AdminPanel/ManageUsers" class="btn hoverView" style="width: 13rem; height: 8rem;">
            <div class="card-body">
                <ion-icon size="large" name="create-outline"></ion-icon>
                <h5 class="card-title">Editar Utilizadores</h5>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6 ">
        <a href="#" class="btn hoverView" style="width: 13rem; height: 8rem;" data-toggle="modal" data-target="#downloadsModal">
            <div class="card-body">
                <ion-icon size="large" name="cloud-download-outline"></ion-icon>
                <h5 class="card-title">Downloads</h5>
            </div>
        </a>
    </div>
</div>
<!-- Downloads Modal -->
<div class="modal fade" id="downloadsModal" tabindex="-1" role="dialog" aria-labelledby="downloadsModal" aria-hidden="true" style="background-color: #1f2029;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: #1f2029; color:white;">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Downloads</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <button type="button" class="btn btn-lg btn-block" style="background-color: #222831;color:white">Projetos e tarefas - Word</button>
                <button type="button" class="btn btn-lg btn-block" style="background-color: #222831;color:white">Projetos e tarefas - Pdf</button>
                <button type="button" class="btn btn-lg btn-block" style="background-color: #222831;color:white">Utilizadores - Word</button>
                <button type="button" class="btn btn-lg btn-block" style="background-color: #222831;color:white">Utilizadores - Pdf</button>
                <button type="button" class="btn btn-lg btn-block" style="background-color: #222831;color:white">Total de Projetos e tarefas - Excel</button>
                <button type="button" class="btn btn-lg btn-block" style="background-color: #222831;color:white">Total de Utilizadores - Excel</button>
            </div>
            <div class="modal-footer">
                <button class="btn hoverView" style="background-color: #1f2029; color: white; " data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1" role="dialog" aria-labelledby="addProject" aria-hidden="true" style="background-color: #1f2029;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: #1f2029; color:white;">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Adicionar Projeto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="projectName">Nome do Projeto:</label>
                        <input type="text" class="form-control" id="projectName" placeholder="Introduza o nome" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="details">Detalhes:</label>
                        <textarea class="form-control" id="details" rows="3" placeholder="Detalhes..." maxlength="255"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Data de Início:</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">Data de Término:</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn hoverView" style="background-color: #1f2029; color: white; " data-dismiss="modal">Fechar</button>
                <button class="btn hoverView" style="background-color: #1f2029; color: white; " id="saveChangesButton">Guardar Alterações</button>
            </div>
        </div>
    </div>
</div>
<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" role="dialog" aria-labelledby="addTaskModalLabel" aria-hidden="true" style="background-color: #1f2029;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: #1f2029; color:white;">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">Adicionar Tarefa</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="projectNameTask">Projeto:</label>
                    <div class="input-group">
                        <input class="form-control" id="projectNameTask" placeholder="Projeto..." readonly>
                        <div class="input-group-append">
                            <button class="btn hoverView" type="button" style="background-color: #1f2029; color: white; " data-toggle="modal" data-target="#projectModal">
                                Selecionar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="taskName">Nome da tarefa:</label>
                    <input class="form-control" id="taskName" placeholder="Nome..." maxlength="50" />
                </div>
                <div class="form-group">
                    <label for="taskDetails">Detalhes da Tarefa:</label>
                    <textarea class="form-control" id="taskDetails" rows="3" placeholder="Detalhes..." maxlength="144"></textarea>
                </div>
                <div class="form-group">
                    <label for="taskEndDate">Data de Término:</label>
                    <input type="date" class="form-control" id="taskEndDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn hoverView" style="background-color: #1f2029; color: white;" data-dismiss="modal">Fechar</button>
                <button class="btn hoverView" style="background-color: #1f2029; color: white;" onclick="saveTask()">Guardar Alterações</button>
            </div>
        </div>
    </div>
</div>
<!-- Project Modal -->
<div class="modal fade" id="projectModal" tabindex="-1" role="dialog" aria-labelledby="projectModalLabel" aria-hidden="true"style="background-color: #1f2029;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: #1f2029;">
            <div class="modal-header" style="color:white;">
                <h5 class="modal-title" id="projectModalLabel">Selecionar Projeto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="search" class="form-control" id="projectSearch" placeholder="Pesquisar projeto...">
                <ul class="list-group mt-2" id="projectList">
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="background-color: #1f2029;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: #1f2029; color:white;">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Adicionar Utilizador</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" class="form-control" id="username" placeholder="Username" maxlength="10" min="3">
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" class="form-control" id="email" placeholder="Email" maxlength="50" min="3">
                    </div>
                    <div class="form-group">
                        <label for="isAdmin">Tipo de Utilizador:</label>
                        <select class="form-control" id="isAdmin">
                            <option value="1">Administrador</option>
                            <option value="0">Padrão</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Estado:</label>
                        <select class="form-control" id="status">
                            <option value="1">Sim</option>
                            <option value="0">Não</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn hoverView" style="background-color: #1f2029; color: white; " data-dismiss="modal">Fechar</button>
                <button class="btn hoverView" style="background-color: #1f2029; color: white; " id="UserSaveChange">Guardar Alterações</button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section scripts{
    <script>
        //downloads
        $(document).ready(function () {
            //GenerateProjectsTasksWord
            $("#downloadsModal").on("click", ".btn-block:eq(0)", function () {
                $.ajax({
                    url: "/AdminPanel/GenerateProjectsTasksWord",
                    type: "GET",
                    success: function (response) {
                        $('#downloadsModal').modal('hide');
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                    }
                });
            });
            //GenerateProjectsTasksPDF
            $("#downloadsModal").on("click", ".btn-block:eq(1)", function () {
                $.ajax({
                    url: "/AdminPanel/GenerateProjectsTasksPDF",
                    type: "GET",
                    success: function (response) {
                        var pdfUrl = response.url;
                        window.open(pdfUrl, "_blank");
                        $('#downloadsModal').modal('hide');
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                    }
                });
            });
            //GenerateUsersWord
            $("#downloadsModal").on("click", ".btn-block:eq(2)", function () {
                $.ajax({
                    url: "/AdminPanel/GenerateUsersWord",
                    type: "GET",
                    success: function (response) {
                        $('#downloadsModal').modal('hide');
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                    }
                });
            });
            //GenerateUsersPDF
            $("#downloadsModal").on("click", ".btn-block:eq(3)", function () {
                $.ajax({
                    url: "/AdminPanel/GenerateUsersPDF",
                    type: "GET",
                    success: function (response) {
                        var pdfUrl = response.url;
                        window.open(pdfUrl, "_blank");
                        $('#downloadsModal').modal('hide');
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                    }
                });
            });
            //GenerateProjectTasksExcel
            $("#downloadsModal").on("click", ".btn-block:eq(4)", function () {
                $.ajax({
                    url: "/AdminPanel/GenerateProjectTasksExcel",
                    type: "GET",
                    success: function (response) {
                        $('#downloadsModal').modal('hide');
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                    }
                });
            });
            //GenerateUsersExcel
            $("#downloadsModal").on("click", ".btn-block:eq(5)", function () {
                $.ajax({
                    url: "/AdminPanel/GenerateUsersExcel",
                    type: "GET",
                    success: function (response) {
                        $('#downloadsModal').modal('hide');
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                    }
                });
            });
        });
        function formatDate(dateString) {
            var date = new Date(dateString);
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        }
        var IdProjectTask = 0;
        $('#projectModal').on('show.bs.modal', loadAllProjects);
        function loadAllProjects() {
            var projectSearch = $('#projectSearch');
            var projectList = $('#projectList');
            projectList.empty();

            $.ajax({
                url: '/AdminPanel/GetProjects',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    response.forEach(function (project) {
                        var projectOption = $('<li class="list-group-item" id="' + project.IdProject + '" style="cursor:pointer;">' + project.name + '</li>');
                        projectOption.on('click', function () {
                            IdProjectTask = project.IdProject;
                            $('#projectNameTask').val(project.name);
                            $('#projectModal').modal('hide');
                        });
                        projectList.append(projectOption);
                    });

                    projectSearch.on('input', function () {
                        var searchTerm = $(this).val().trim().toLowerCase();
                        projectList.empty();

                        var filteredProjects = response.filter(function (project) {
                            return project.name.toLowerCase().includes(searchTerm);
                        });

                        if (filteredProjects.length > 0) {
                            filteredProjects.forEach(function (project) {
                                var projectOption = $('<li class="list-group-item">' + project.name + '</li>');
                                projectOption.on('click', function () {
                                    IdProjectTask = project.IdProject;
                                    $('#projectNameTask').val(project.name);
                                    $('#projectModal').modal('hide');
                                });
                                projectList.append(projectOption);
                            });
                        } else {
                            var noResultsMessage = $('<li class="list-group-item disabled">Nenhum projeto encontrado</li>');
                            projectList.append(noResultsMessage);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.log(xhr);
                }
            });
        }
        function saveTask() {
            var projectId = IdProjectTask
            var taskDetails = $('#taskDetails').val();
            var taskEndDate = formatDate($('#taskEndDate').val());
            var taskName = $('#taskName').val();

            if (taskName && taskDetails && taskEndDate) {
                $.ajax({
                    url: '/AdminPanel/SaveTask',
                    type: 'POST',
                    data: {
                        projectId: projectId,
                        taskDetails: taskDetails,
                        taskName: taskName,
                        status: '1',
                        taskEndDate: taskEndDate
                    },
                    success: function (response) {
                        if (response.success == true) {
                            Swal.fire({
                                title: 'Sucesso!',
                                text: 'Tarefa adicionada com sucesso!',
                                icon: 'success',
                                customClass: 'custom-swal',
                                confirmButtonText: 'OK'
                            }).then(function () {
                                $('#taskDetails').val('');
                                $('#taskEndDate').val('');
                                $('#addTaskModal').modal('hide');
                            });
                        } else {
                            Swal.fire({
                                title: 'Erro!',
                                text: 'A data de término da tarefa está fora do intervalo de datas do projeto.',
                                icon: 'error',
                                customClass: 'custom-swal',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire({
                            title: 'Erro!',
                            text: 'Ocorreu um erro ao adicionar a tarefa.',
                            icon: 'error',
                            customClass: 'custom-swal',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            } else {
                Swal.fire({
                    title: 'Erro!',
                    text: 'Por favor, preencha todos os campos.',
                    icon: 'error',
                    customClass: 'custom-swal',
                    confirmButtonText: 'OK'
                });
            }
        }
        $(document).ready(function () {
            $('#addUserModal form').submit(function (e) {
                e.preventDefault();
            });
            $('#addUserModal').on('click', '#UserSaveChange', function () {
                var username = $('#username').val();
                var email = $('#email').val();
                var isAdmin = $('#isAdmin').val();
                var status = $('#status').val();

                if (username && email && isAdmin && status) {
                    var formData = {
                        username: username,
                        email: email,
                        isAdmin: isAdmin,
                        status: status
                    };

                    $.ajax({
                        type: 'POST',
                        url: '/Accounts/AddUser',
                        data: formData,
                        success: function (result) {
                            if (result.success) {
                                Swal.fire({
                                    title: 'Sucesso!',
                                    text: 'Utilizador adicionado com sucesso!',
                                    icon: 'success',
                                    customClass: 'custom-swal',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        $('#addUser').modal('hide');
                                    }
                                });
                            } else {
                                Swal.fire({
                                    title: 'Erro!',
                                    text: 'Ocorreu um erro ao adicionar o utilizador.',
                                    icon: 'error',
                                    customClass: 'custom-swal',
                                    confirmButtonText: 'OK'
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                title: 'Erro!',
                                text: 'Ocorreu um erro no sistema, tente novamente mais logo.',
                                icon: 'error',
                                customClass: 'custom-swal',
                                confirmButtonText: 'OK'
                            }).then(function () {
                                location.reload();
                            });
                        }
                    });
                } else {
                    Swal.fire({
                        title: 'Erro!',
                        text: 'Por favor, preencha todos os campos.',
                        icon: 'error',
                        customClass: 'custom-swal',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });
        $(document).ready(function () {
            $('#addProjectModal form').submit(function (e) {
                e.preventDefault();
            });

            $('#addProjectModal').on('click', '#saveChangesButton', function () {
                var projectName = $('#projectName').val();
                var projectStartDate = $('#startDate').val();
                var projectDetails = $('#details').val();
                var projectEndDate = $('#endDate').val();

                if (!projectName || !projectStartDate || !projectEndDate) {
                    Swal.fire({
                        title: 'Erro!',
                        text: 'Por favor, preencha todos os campos.',
                        icon: 'error',
                        customClass: 'custom-swal',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                if (!validateDates(projectStartDate, projectEndDate)) {
                    Swal.fire({
                        title: 'Erro!',
                        text: 'As datas informadas não são válidas.',
                        icon: 'error',
                        customClass: 'custom-swal',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                var formData = {
                    name: projectName,
                    description: projectDetails,
                    startDate: projectStartDate,
                    endDate: projectEndDate
                };

                $.ajax({
                    type: 'POST',
                    url: '/AdminPanel/CreateProject',
                    data: formData,
                    success: function (response) {
                        Swal.fire({
                            title: 'Sucesso!',
                            text: 'Projeto criado com sucesso!',
                            icon: 'success',
                            customClass: 'custom-swal',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $('#addProjectModal').modal('hide');
                            }
                        });
                    },
                    error: function (error) {
                        Swal.fire({
                            title: 'Erro!',
                            text: 'Ocorreu um erro ao criar o projeto.',
                            icon: 'error',
                            customClass: 'custom-swal',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
        });
        function validateDates(startDate, endDate) {
            var today = new Date();
            today.setHours(0, 0, 0, 0);

            var start = new Date(startDate);
            var end = new Date(endDate);

            var startYear = start.getFullYear();
            var startMonth = start.getMonth();
            var startDay = start.getDate();

            var endYear = end.getFullYear();
            var endMonth = end.getMonth();
            var endDay = end.getDate();

            if (startYear < today.getFullYear() ||
                (startYear === today.getFullYear() && startMonth < today.getMonth()) ||
                (startYear === today.getFullYear() && startMonth === today.getMonth() && startDay < today.getDate())) {
                return false;
            }

            if (endYear < startYear ||
                (endYear === startYear && endMonth < startMonth) ||
                (endYear === startYear && endMonth === startMonth && endDay <= startDay)) {
                return false;
            }

            return true;
        }
    </script>
}